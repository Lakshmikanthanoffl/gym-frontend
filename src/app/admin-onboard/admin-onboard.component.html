<div class="table-wrapper">
  <!-- Page Header -->
<div class="page-header d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  
  <!-- Search input -->
  <div class="p-inputgroup search-bar" style="flex: 1 1 300px; max-width: 400px;">
    <span class="p-inputgroup-addon">
      <i class="pi pi-search"></i>
    </span>
    <input
      type="text"
      pInputText
      placeholder="Search by role, username, email, gym, or plan"
      [(ngModel)]="searchTerm"
      (ngModelChange)="filterRoles()"
      class="w-full"
    />
  </div>

  <!-- Buttons -->
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <!-- Add Admin Button -->
    <button 
      pButton
      type="button"
      label="Add Admin"
      icon="pi pi-plus"
      class="p-button-success p-button-rounded p-button-outlined px-4 py-2 shadow-sm"
      style="border-radius: 30px; font-weight: 500;"
      (click)="openAddAdminDialog()">
    </button>

    <!-- Export Button -->
    <button 
      pButton
      type="button"
      label="Export"
      icon="pi pi-download"
      class="p-button-info p-button-rounded p-button px-4 py-2 shadow-sm"
      style="border-radius: 30px; font-weight: 500;"
      (click)="menu.toggle($event)">
    </button>
    <p-menu 
      #menu
      [popup]="true"
      [model]="exportItems"
      styleClass="dark-menu">
    </p-menu>
  </div>

</div>

  <!-- Reusable Dialog -->
  <p-dialog 
    styleClass="dark-dialog"
    [header]="isEditMode ? 'Edit Admin' : 'Onboard Admin'" 
    [(visible)]="showDialog" 
    [modal]="true" 
    [dismissableMask]="true"  
    [closable]="true" 
    [style]="{width: '700px'}" 
    [resizable]="false">

    <div class="p-fluid">
      <!-- Role -->
      <div class="field-row">
        <label class="w-30">Role</label>
        <p-dropdown 
          [options]="rolesDropdown" 
          optionLabel="label" 
          optionValue="value" 
          [(ngModel)]="admin.roleName" 
          class="flex-grow-1">
        </p-dropdown>
      </div>

      <!-- Username -->
      <div class="field-row">
        <label class="w-30" for="userName">Username</label>
        <input id="userName" type="text" pInputText [(ngModel)]="admin.userName" class="flex-grow-1"/>
      </div>

      <!-- Email -->
      <div class="field-row">
        <label class="w-30" for="userEmail">Email ID</label>
        <input id="userEmail" type="email" pInputText [(ngModel)]="admin.userEmail" class="flex-grow-1"/>
      </div>

      <!-- Password -->
      <div class="field-row">
        <label class="w-30" for="password">Password</label>
        <div class="flex-grow-1 d-flex align-items-center">
          <input 
            id="password"
            [type]="passwordVisible ? 'text' : 'password'"
            pInputText
            [(ngModel)]="admin.password"
            class="flex-grow-1"
          />
          <button 
            pButton 
            type="button"
            class="p-button-rounded p-button-secondary ml-2"
            [icon]="passwordVisible ? 'pi pi-eye' : 'pi pi-eye-slash'"
            (click)="passwordVisible = !passwordVisible">
          </button>
        </div>
      </div>

      <!-- Plan Name -->
<div class="field-row d-flex align-items-center">
  <label class="w-30" for="planName">Plan Name</label>
  <p-dropdown
    id="planName"
    [options]="subscriptionPlans"
    [(ngModel)]="admin.planName"
    optionLabel="name"
    optionValue="name"
    placeholder="Select Plan"
    class="flex-grow-1"
    (onChange)="onPlanChange($event.value)"
  ></p-dropdown>
</div>

<!-- Subscription Period -->
<div class="field-row d-flex align-items-center">
  <label class="w-30" for="subscriptionPeriod">Subscription</label>
  <p-dropdown
    id="subscriptionPeriod"
    [options]="[
      { label: 'Monthly', value: 'monthly' },
      { label: 'Quarterly', value: 'quarterly' },
      { label: 'Yearly', value: 'yearly' }
    ]"
    [(ngModel)]="admin.subscriptionPeriod"
    optionLabel="label"
    optionValue="value"
    class="flex-grow-1"
    (onChange)="onSubscriptionChange($event.value)"
  ></p-dropdown>
</div>

      <!-- Paid Date -->
      <div class="field-row d-flex align-items-center">
        <label class="w-30" for="paidDate">Paid Date</label>
        <p-calendar
          id="paidDate"
          [(ngModel)]="admin.paidDate"
          name="paidDate"
          [showTime]="true"
          dateFormat="M d, yy"
          hourFormat="12"
          [showIcon]="true"
          [showButtonBar]="true"
          [monthNavigator]="true"
          [yearNavigator]="true"
          yearRange="2000:2035"
          appendTo="body"
          class="flex-grow-1 calendar-sm"
          (onSelect)="onPaidDateChange($event)"
        ></p-calendar>
      </div>

      <!-- Valid Until -->
      <div class="field-row d-flex align-items-center">
        <label class="w-30" for="validUntil">Valid Until</label>
        <p-calendar
          id="validUntil"
          [(ngModel)]="admin.validUntil"
          name="validUntil"
          [showTime]="true"
          dateFormat="M d, yy"
          hourFormat="12"
          [showIcon]="true"
          [showButtonBar]="true"
          [monthNavigator]="true"
          [yearNavigator]="true"
          yearRange="2000:2035"
          appendTo="body"
          class="flex-grow-1 calendar-sm"
        ></p-calendar>
      </div>

      <!-- Amount Paid -->
      <div class="field-row d-flex align-items-center">
        <label class="w-30" for="amountPaid">Amount Paid</label>
        <p-inputNumber
          id="amountPaid"
          [(ngModel)]="admin.amountPaid"
          mode="currency"
          currency="INR"
          locale="en-IN"
          class="flex-grow-1"
        ></p-inputNumber>
      </div>

      <!-- Is Active Toggle -->
      <div class="field-row d-flex align-items-center">
        <label class="w-30" for="isActive">Is Active</label>
        <p-inputSwitch
          id="isActive"
          [(ngModel)]="admin.isActive"
          [style]="{width: '60px'}"
        ></p-inputSwitch>
      </div>

      <!-- Gym selection (Superadmin only) -->
      <div *ngIf="userrole === 'superadmin'" class="field-row d-flex align-items-center">
        <label class="form-label w-30">Gym</label>
        <ng-container *ngIf="!manualGymEntry; else manualGym">
          <p-dropdown
            id="gymId"
            [options]="availableGyms"
            [(ngModel)]="admin.gymId"
            optionLabel="name"
            optionValue="id"
            placeholder="Select Gym"
            class="flex-grow-1"
            appendTo="body" 
            (onChange)="onGymChange($event.value)">
          </p-dropdown>
          <button pButton type="button" icon="pi pi-plus" class="p-button-rounded p-button-success ml-2" 
                  title="Add New Gym" (click)="manualGymEntry = true"></button>
        </ng-container>
        <ng-template #manualGym>
          <input id="gymId" type="text" pInputText [(ngModel)]="admin.gymId" placeholder="Enter Gym ID" class="flex-grow-1 mr-2"/>
          <input id="gymName" type="text" pInputText [(ngModel)]="admin.gymName" placeholder="Enter Gym Name" class="flex-grow-1"/>
          <button pButton type="button" icon="pi pi-arrow-left" class="p-button-rounded p-button-secondary ml-2" 
                  title="Back" (click)="manualGymEntry = false"></button>
        </ng-template>
      </div>

      <div class="field-row mt-3">
        <label class="w-30">Menu Privileges</label>
        <p-multiSelect 
          [options]="availableMenus"
          [(ngModel)]="admin.privileges"
          optionLabel="label"
          optionValue="value"
          display="chip"
          placeholder="Select Menus"
          class="flex-grow-1"
          appendTo="body">
        </p-multiSelect>
      </div>
      


      <!-- Save / Update -->
      <div class="text-right mt-3">
        <button pButton 
                type="button" 
                [label]="isEditMode ? 'Update' : 'Save'" 
                icon="pi pi-check" 
                (click)="isEditMode ? updateAdmin() : saveAdmin()">
        </button>
      </div>
    </div>
  </p-dialog>

  <!-- ================================
       Desktop Table
  ================================= -->
    <div class="desktop-table-wrapper">
      <p-table 
        class="dark-table" 
        [value]="filteredRolesList" 
        [paginator]="true" 
        [rows]="10" 
        [responsiveLayout]="'scroll'">
        <ng-template pTemplate="header">
          <tr>
            <th>Role ID</th>
            <th>Role Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Gym ID</th>
            <th>Gym Name</th>
            <th>Valid Until</th>
            <th>Plan</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-role>
          <tr>
            <td>{{ role.roleId }}</td>
            <td>{{ role.roleName }}</td>
            <td>{{ role.userName }}</td>
            <td>{{ role.userEmail }}</td>
            <td>{{ role.gymId }}</td>
            <td>{{ role.gymName }}</td>
            <td>{{ role.validUntil | date: 'mediumDate' }}</td>
            <td>
              <span [ngClass]="getPlanClass(role.planDisplay)">
                {{ role.planDisplay }}
              </span>
            </td>
            

            <td>
              <span [ngClass]="role.validUntil ? getStatusClass(role.validUntil) : 'Unknown'">
                {{ role.validUntil ? getStatus(role.validUntil) : 'Unknown'  }}
              </span>
            </td>
            <td>
              <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editRole(role)"></button>
              <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="confirmDeleteRole(role)"></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

  <!-- ================================
       Mobile / Tablet Accordion
  ================================= -->
  <div class="mobile-accordion-wrapper">
    <p-accordion *ngIf="filteredRolesList?.length">
      <p-accordionTab *ngFor="let role of filteredRolesList" [header]="'Username: ' + role.userName">
        <div class="accordion-row"><strong>Role ID:</strong> {{ role.roleId }}</div>
        <div class="accordion-row"><strong>Role Name:</strong> {{ role.roleName }}</div>
        <div class="accordion-row"><strong>Email:</strong> {{ role.userEmail }}</div>
        <div class="accordion-row"><strong>Gym ID:</strong> {{ role.gymId }}</div>
        <div class="accordion-row"><strong>Gym Name:</strong> {{ role.gymName }}</div>
        <div class="accordion-row"><strong>Valid Until:</strong> {{ role.validUntil | date: 'mediumDate' }}</div>
        <div class="accordion-row">
          <strong>Plan:</strong>
          <span [ngClass]="getPlanClass(role.planDisplay)">
            {{ role.planDisplay }}
          </span>
        </div>
        
        <div class="accordion-row">
          <strong>Status:</strong> 
          <span [ngClass]="role.validUntil ? getStatusClass(role.validUntil) : 'Unknown'">
            {{ role.validUntil ? getStatus(role.validUntil) : 'Unknown'  }}
          </span>
        </div>
        <div class="accordion-actions">
          <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editRole(role)"></button>
          <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="confirmDeleteRole(role)"></button>
        </div>
      </p-accordionTab>
    </p-accordion>
  
</div>



</div>
<!-- ✅ Delete Confirmation Dialog -->
<p-dialog
styleClass="delete-dialog"
  header="Confirm Delete"
  [(visible)]="deleteDialogVisible"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '400px' }"
>
  <p class="mb-3">
    Are you sure you want to delete the role 
    <b>{{ roleToDelete?.roleName }}</b> for user 
    <b>{{ roleToDelete?.userName }}</b>?<br />
    Type <b>delete</b> in the box below to confirm.
  </p>

  <input
    type="text"
    pInputText
    [(ngModel)]="deleteConfirmationText"
    placeholder="Type 'delete' to confirm"
    class="w-full mb-3"
  />

  <div class="d-flex justify-content-end gap-2">
    <button
      pButton
      type="button"
      label="Cancel"
      class="p-button-secondary"
      (click)="deleteDialogVisible = false; deleteConfirmationText = ''"
    ></button>
    <button
      pButton
      type="button"
      label="Delete"
      class="p-button-danger"
      (click)="deleteRole()"
      [disabled]="deleteConfirmationText.trim().toLowerCase() !== 'delete'"
    ></button>
  </div>
</p-dialog>
