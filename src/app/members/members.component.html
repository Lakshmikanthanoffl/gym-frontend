<div class="table-wrapper">
  <!-- Top Row: Search + Add Member + QR Scanner -->
  <div class="page-header d-flex align-items-center justify-content-between mb-3">
    <!-- Search box -->
    <div class="p-inputgroup search-bar" style="flex: 0 0 400px;">
      <span class="p-inputgroup-addon"><i class="pi pi-search"></i></span>
      <input
        type="text"
        pInputText
        placeholder="Search by name, email, phone or gym"
        [(ngModel)]="searchTerm"
        (ngModelChange)="filterMembers()"
        class="w-full"
      />
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 align-items-center">
      <button
        pButton
        label="Add Member"
        icon="pi pi-plus"
        class="p-button-rounded p-button-success p-button-outlined px-4 py-2"
        (click)="showAddDialog()"
      ></button>

      <button *ngIf="hasPrivilege('export')"
        pButton
        label="Export"
        icon="pi pi-download"
        class="p-button-rounded p-button-info px-4 py-2"
        (click)="menu.toggle($event)"
      ></button>
      <p-menu #menu [popup]="true" [model]="exportItems" styleClass="dark-menu"></p-menu>
      <button *ngIf="hasPrivilege('Qr Attendance-Tracking')"
      pButton
      label="Open QR Scanner"
      icon="pi pi-qrcode"
      class="p-button-rounded p-button-warning px-4 py-2"
      (click)="openQrScanner()"
    ></button>
     
    </div>
  </div>

  <!-- QR Scanner Section -->
  <p-dialog 
  header="QR Scanner" 
  [(visible)]="qrScannerDialogVisible"
  [modal]="true"
  [closable]="false"          
  [dismissableMask]="false"   
  [closeOnEscape]="false" 
  [style]="{ width: '500px' }"
  styleClass="qr-scanner-dialog"   
  (onHide)="closeCamera()"
>

  <div class="scanner-container text-center">
    
    <!-- ZXing Scanner (Only render when dialog is open) -->
    <zxing-scanner
      *ngIf="qrScannerDialogVisible"
      [formats]="allowedFormats"
      (scanSuccess)="onCodeResult($event)"
      [device]="selectedDevice"
      [videoConstraints]="videoConstraints"
      (camerasFound)="onCamerasFound($event)"
      class="scanner"
      [enable]="qrScannerDialogVisible"
    ></zxing-scanner>

    <!-- Camera Selection for Desktop -->
    <div *ngIf="!isMobile && qrScannerDialogVisible" class="mt-3">
      <p-dropdown
  [options]="cameraOptions"
  [(ngModel)]="selectedDevice"
  placeholder="Select Camera"
  optionLabel="label"
  optionValue="value"  
  appendTo="body"
  [style.width.%]="100"
></p-dropdown>
    </div>

    <!-- Mobile Camera Toggle -->
    <div *ngIf="isMobile && qrScannerDialogVisible" class="mt-3">
      <button
        pButton
        type="button"
        (click)="toggleCamera()"
        [label]="isFrontCamera ? 'Switch to Back Camera' : 'Switch to Front Camera'"
        icon="pi pi-refresh"
        class="p-button-rounded p-button-info"
      ></button>
    </div>

    <!-- Close Camera Button -->
    <div *ngIf="qrScannerDialogVisible" class="mt-3">
      <button 
        pButton
        type="button"
        label="Close Scanner"
        icon="pi pi-times"
        class="p-button-danger"
        (click)="confirmCloseScanner()"
      ></button>
    </div>
  </div>
</p-dialog>



  <div *ngIf="scannedResult" class="mt-2 text-center">
    <p><strong>Last Scanned Member ID:</strong> {{ scannedResult }}</p>
  </div>
  

  <div class="table-wrapper responsive-table">

    <!-- Desktop Table -->
    <p-table
        *ngIf="!isMobile"
        [value]="filteredMembers"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20]"
        [sortField]="'id'"
        [sortOrder]="1"
        class="p-datatable-gridlines dark-table">
  
      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th *ngIf="userrole === 'superadmin'">Gym ID</th>
          <th *ngIf="userrole === 'superadmin'">Gym Name</th>
          <th>Status</th>
          <th *ngIf="hasPrivilege('manual Attendance-Tracking')">Attendance</th>
          <th class="text-center">Actions</th>
        </tr>
      </ng-template>
  
      <!-- Table Body -->
      <ng-template pTemplate="body" let-member>
        <tr>
          <td>{{ member.id }}</td>
          <td>{{ member.name }}</td>
          <td>{{ member.email }}</td>
          <td>{{ member.phone }}</td>
  
          <td *ngIf="userrole === 'superadmin'">{{ member.gymId || '-' }}</td>
          <td *ngIf="userrole === 'superadmin'">{{ member.gymName || '-' }}</td>
  
          <td>
            <span [ngClass]="getStatusClass(member.validUntil)">
              {{ getStatus(member.validUntil) }}
            </span>
          </td>
  
          <!-- Attendance Column -->
          <td *ngIf="hasPrivilege('manual Attendance-Tracking')" class="text-center">
            <div class="d-flex flex-column align-items-center">
              <div class="mb-2">
                <span *ngIf="getMonthlyAttendance(member) > 0; else noAttendance">
                  {{ getMonthlyAttendance(member) }} / {{ getTotalDaysInMonth(selectedMonth, currentYear) }}
                </span>
                <ng-template #noAttendance>
                  <span class="p-tag p-tag-warning">0</span>
                </ng-template>
              </div>
  
              <div class="attendance-grid">
                <ng-container *ngFor="let day of member.attendance">
                  <span *ngIf="isInSelectedMonth(day)" class="p-tag p-tag-success">
                    {{ day | date:'d MMM' }}
                  </span>
                </ng-container>
              </div>
  
              <button 
                pButton 
                type="button" 
                class="p-button-rounded p-button-sm mt-2"
                [icon]="isAttendanceMarkedToday(member) ? 'pi pi-check' : 'pi pi-user-plus'"
                (click)="markAttendance(member)" 
                [disabled]="isAttendanceMarkedToday(member)"
                [ngClass]="{
                  'p-button-success': isAttendanceMarkedToday(member), 
                  'p-button-primary': !isAttendanceMarkedToday(member)
                }"
                [pTooltip]="isAttendanceMarkedToday(member) ? 'Already marked today' : 'Mark attendance'"
                tooltipPosition="top">
              </button>
            </div>
          </td>
  
          <!-- Actions -->
          <td class="text-center">
            <button *ngIf="hasPrivilege('Qr Attendance-Tracking')"
                    pButton 
                    type="button" 
                    icon="pi pi-qrcode" 
                    class="p-button-rounded p-button-text p-button-sm"
                    (click)="openMemberQR(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm p-button-info me-2"
              (click)="viewMember(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm p-button-primary me-2"
              (click)="editMember(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-sm p-button-danger"
              (click)="confirmDelete(member)">
            </button>
          </td>
        </tr>
      </ng-template>
  
      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="userrole === 'superadmin' ? 9 : 7" class="text-center">
            No records found
          </td>
        </tr>
      </ng-template>
    </p-table>
  
    <!-- Mobile Accordion Tabs -->
    <div class="mobile-accordion-wrapper">
    <ng-container *ngIf="isMobile">
      <p-accordion [multiple]="true">
        <p-accordionTab *ngFor="let member of filteredMembers" [header]="member.name">
          <div><strong>ID:</strong> {{ member.id }}</div>
          <div><strong>Email:</strong> {{ member.email }}</div>
          <div><strong>Phone:</strong> {{ member.phone }}</div>
          <div *ngIf="userrole === 'superadmin'"><strong>Gym ID:</strong> {{ member.gymId || '-' }}</div>
          <div *ngIf="userrole === 'superadmin'"><strong>Gym Name:</strong> {{ member.gymName || '-' }}</div>
          <div><strong>Status:</strong> <span [ngClass]="getStatusClass(member.validUntil)">{{ getStatus(member.validUntil) }}</span></div>
  
          <div *ngIf="hasPrivilege('manual Attendance-Tracking')">
            <div><strong>Attendance:</strong> {{ getMonthlyAttendance(member) }} / {{ getTotalDaysInMonth(selectedMonth, currentYear) }}</div>
            <div class="attendance-grid">
              <ng-container *ngFor="let day of member.attendance">
                <span *ngIf="isInSelectedMonth(day)" class="p-tag p-tag-success">{{ day | date:'d MMM' }}</span>
              </ng-container>
            </div>
            <button 
              pButton 
              type="button" 
              class="p-button-rounded p-button-sm mt-2"
              [icon]="isAttendanceMarkedToday(member) ? 'pi pi-check' : 'pi pi-user-plus'"
              (click)="markAttendance(member)" 
              [disabled]="isAttendanceMarkedToday(member)"
              [ngClass]="{
                'p-button-success': isAttendanceMarkedToday(member), 
                'p-button-primary': !isAttendanceMarkedToday(member)
              }"
              [pTooltip]="isAttendanceMarkedToday(member) ? 'Already marked today' : 'Mark attendance'"
              tooltipPosition="top">
            </button>
          </div>
  
          <div class="mt-2">
            <button *ngIf="hasPrivilege('Qr Attendance-Tracking')"
                    pButton 
                    type="button" 
                    icon="pi pi-qrcode" 
                    class="p-button-rounded p-button-text p-button-sm"
                    (click)="openMemberQR(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm p-button-info me-2"
              (click)="viewMember(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm p-button-primary me-2"
              (click)="editMember(member)">
            </button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-sm p-button-danger"
              (click)="confirmDelete(member)">
            </button>
          </div>
        </p-accordionTab>
      </p-accordion>
    </ng-container>
    </div>
  </div>
  
</div>

<!-- QR code dialog -->
<!-- QR dialog -->
<p-dialog header="Member QR Code" [(visible)]="qrDialogVisible" [modal]="true" [closable]="true" [resizable]="false">
  <div class="text-center">
    <img 
    *ngIf="selectedMemberId !== null"
    [src]="getMemberQrUrl(selectedMemberId)" 
    alt="QR Code" 
    class="qr-image"
  />
  

    <button 
      pButton 
      type="button" 
      label="Download QR" 
      icon="pi pi-download"
      class="mt-3"
      (click)="downloadMemberQr()">
    </button>
  </div>
</p-dialog>
  <p-dialog
  header="Confirm Delete"
  [(visible)]="deleteDialogVisible"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '400px' }"
>
  <p class="mb-3">
    Are you sure you want to delete <b>{{ memberToDelete?.name }}</b>?<br />
    Type <b>delete</b> in the box below to confirm.
  </p>

  <input
    type="text"
    pInputText
    [(ngModel)]="deleteConfirmationText"
    placeholder="Type 'delete' to confirm"
    class="w-full mb-3"
  />

  <div class="d-flex justify-content-end gap-2">
    <button
      pButton
      type="button"
      label="Cancel"
      class="p-button-secondary"
      (click)="deleteDialogVisible = false"
    ></button>
    <button
      pButton
      type="button"
      label="Delete"
      class="p-button-danger"
      (click)="deleteMember()"
      [disabled]="deleteConfirmationText.trim().toLowerCase() !== 'delete'"
    ></button>
  </div>
</p-dialog>


  <!-- Add Member Dialog -->
  <p-dialog 
  [header]="isEditMode ? 'Edit Member' : 'Add New Member'"
  [(visible)]="addDialogVisible"
  [modal]="true"
  [style]="{ width: '600px' }"
  [closable]="true"
  [dismissableMask]="true"
  (onHide)="resetOtpState()"
>

  <form class="p-fluid">
    <!-- Name -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="name" class="form-label w-40">Name</label>
      <input
        pInputText
        id="name"
        [(ngModel)]="newMember.name"
        name="name"
        class="flex-grow-1"
      />
    </div>
    
    <!-- Email -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="email" class="form-label w-40">Email</label>
      <input
        pInputText
        id="email"
        [(ngModel)]="newMember.email"
        name="email"
        class="flex-grow-1"
      />
    </div>
    
    <!-- Phone -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="phone" class="form-label w-40">Phone</label>
      <input
        pInputText
        id="phone"
        [(ngModel)]="newMember.phone"
        name="phone"
        class="flex-grow-1"
      />
    </div>

    <!-- Gym ID & Gym Name (Superadmin only) -->
    <!-- Gym selection (Superadmin only) -->
    <div *ngIf="userrole === 'superadmin'" class="field mb-2 d-flex align-items-center">
      <label for="gymId" class="form-label w-40">Gym</label>
      <p-dropdown
        id="gymId"
        [options]="availableGyms"
        [(ngModel)]="newMember.gymId"
        optionLabel="name"
        optionValue="id"
        placeholder="Select Gym"
        class="flex-grow-1"
        (onChange)="onGymChange($event.value)"
        name="gymId"
      ></p-dropdown>
    </div>
    
    <!-- Subscription Type -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="subscriptionType" class="form-label w-40">Subscription Type</label>
      <p-dropdown 
        id="subscriptionType"
        [options]="filteredSubscriptions"
        [(ngModel)]="newMember.subscriptionType"
        optionLabel="label"
        placeholder="Select Subscription"
        name="subscriptionType"
        class="flex-grow-1"
        (onChange)="onSubscriptionTypeChange($event.value)"
      ></p-dropdown>
    </div>

    <!-- Period -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="period" class="form-label w-40">Period</label>
      <input 
        pInputText 
        id="period" 
        [(ngModel)]="newMember.period" 
        name="period" 
        class="flex-grow-1" 
        readonly
      />
    </div>
    
    <!-- Amount Paid -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="amountPaid" class="form-label w-40">Amount Paid</label>
      <input 
        pInputText 
        id="amountPaid" 
        [(ngModel)]="newMember.amountPaid" 
        name="amountPaid" 
        class="flex-grow-1" 
      />
    </div>
    
    <!-- Paid Date -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="paidDate" class="form-label w-40">Paid Date</label>
      <p-calendar
        id="paidDate"
        [(ngModel)]="newMember.paidDate"
        name="paidDate"
        (onSelect)="onPaidDateChange()"
        [showTime]="true"
        dateFormat="M d, yy"
        hourFormat="12"
        [showIcon]="true"
        [showButtonBar]="true"
        [monthNavigator]="true"
        [yearNavigator]="true"
        yearRange="2000:2035"
        appendTo="body"
        class="flex-grow-1 calendar-sm"
      ></p-calendar>
    </div>
    
    <!-- Valid Until -->
    <div class="field mb-2 d-flex align-items-center">
      <label for="validUntil" class="form-label w-40">Valid Until</label>
      <p-calendar
        id="validUntil"
        [(ngModel)]="newMember.validUntil"
        name="validUntil"
        [showTime]="true"
        dateFormat="M d, yy"
        hourFormat="12"
        [showIcon]="true"
        [showButtonBar]="true"
        [monthNavigator]="true"
        [yearNavigator]="true"
        yearRange="2000:2035"
        appendTo="body"
        class="flex-grow-1 calendar-sm"
      ></p-calendar>
    </div>
    
    <!-- Save button -->
    <button
      pButton
      type="button"
      label="Save"
      icon="pi pi-check"
      class="p-button-sm p-button-success"
      (click)="saveMember()"
    ></button>
  </form>
</p-dialog>


<p-dialog
  header="Verify OTP"
  [(visible)]="otpDialogVisible"
  [modal]="true"
  [closable]="true"  
  [style]="{ width: '400px' }"
  (onHide)="resetOtpDialog()"
>
  <div class="p-fluid">
    <p class="mb-3">An OTP has been sent to {{ newMember.phone }}.</p>

    <div class="field mb-2 d-flex align-items-center">
      <label for="otp" class="form-label w-40">Enter OTP</label>
      <input
        pInputText
        id="otp"
        [(ngModel)]="enteredOtp"
        name="otp"
        class="flex-grow-1"
      />
    </div>

    <div class="text-end mt-3">
      <button
        pButton
        label="Verify"
        icon="pi pi-check"
        class="p-button-sm p-button-success"
        (click)="verifyOTP()"
      ></button>
    </div>
  </div>
</p-dialog>



  <!-- Edit Popup -->
  <p-dialog
    header="Member Details"
    [(visible)]="editDialogVisible"
    [modal]="true"
    [style]="{ width: '450px' }"
    [closable]="true"
    [dismissableMask]="true"
  >
    <div *ngIf="selectedMember">
      <p><strong>Name:</strong> {{ selectedMember.name }}</p>
      <p><strong>Email:</strong> {{ selectedMember.email }}</p>
      <p><strong>Phone:</strong> {{ selectedMember.phone }}</p>
      <p><strong>Subscription Type:</strong> {{ selectedMember.subscriptionType.value }}</p>
      <p><strong>Period:</strong> {{ selectedMember.period }}</p>
      <p><strong>Amount Paid:</strong> â‚¹{{ selectedMember.amountPaid }}</p>
      <p><strong>Paid Date:</strong> {{ selectedMember.paidDate | date:'medium' }}</p>
      <p><strong>Validity:</strong> {{ selectedMember.validUntil | date:'medium' }}</p>
    </div>
  </p-dialog>
  